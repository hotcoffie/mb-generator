<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mybatis代码生成器</title>
    <link href="/css/bootstrap.css" rel="stylesheet">
    <style>
        tbody tr td input {
            border: 0;
            width: 100%;
            height: 100%;
            min-height: 30px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center" style="margin-bottom: 30px;">Mybatis代码生成器
        <small>Ver. 1.0.0</small>
    </h2>
    <div class="form-horizontal">
        <div class="form-group">
            <label for="tableList" class="col-sm-2 control-label">选择表</label>
            <div class="col-sm-4">
                <select class="form-control" id="tableList" onchange="initCode();"></select>
            </div>
            <label for="tableComment" class="col-sm-2 control-label">表注释</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="tableComment" placeholder="作为类的默认注释，支持手动调整"/>
            </div>
        </div>
        <div class="form-group">
            <label for="className" class="col-sm-2 control-label">对应类名</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="className" placeholder="自动转换表对应的类名，支持手动调整"/>
            </div>
            <label for="author" class="col-sm-2 control-label">作者</label>
            <div class="col-sm-4">
                <input type="text" class="form-control" id="author" placeholder="类注释中的作者信息"/>
            </div>
        </div>
        <div class="form-group">
            <label for="codeLevel" class="col-sm-2 control-label">生成范围</label>
            <div class="col-sm-4">
                <select class="form-control" id="codeLevel">
                    <option value="1">Entity</option>
                    <option value="2">Entity+DAO</option>
                    <option value="3">Entity+DAO+Service</option>
                    <option value="4">Entity+DAO+Service+Controller</option>
                </select>
            </div>
            <label class="col-sm-2 control-label">Swagger-UI</label>
            <div class="col-sm-4">
                <label class="checkbox-inline">
                    <input type="checkbox" id="useSwagger"/> 使用
                </label>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-condensed" id="colTable">
                <thead>
                <tr>
                    <th>编号</th>
                    <th>字段名</th>
                    <th>数据类型</th>
                    <th>属性名</th>
                    <th>属性类型</th>
                    <th>主键</th>
                    <th>注释</th>
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
        <div class="form-group">
            <div class="col-sm-offset-4 col-sm-3">
                <button type="button" class="btn btn-success" onclick="createCode();">
                    <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                    生成代码
                </button>
                <button type="button" class="btn btn-primary">
                    <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                    下载文件
                </button>
            </div>
        </div>
    </div>
    <div id="myAlert" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">提示</h4>
                </div>
                <div class="modal-body">
                    <p>...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <div class="form">
        <div level="1" class="hide">
            <div class="form-group">
                <label for="entityText">Entity</label>
                <textarea id="entityText" class="form-control" rows="3"
                          placeholder="自动生成的Entity.class，支持手动调整"></textarea>
            </div>
        </div>
        <div level="2" class="hide">
            <div class="form-group">
                <label for="mapperText">Mapper</label>
                <textarea id="mapperText" class="form-control" rows="3" placeholder="自动生成的Mapper.xml，支持手动调整"></textarea>
            </div>
            <div class="form-group">
                <label for="daoText">DAO</label>
                <textarea id="daoText" class="form-control" rows="3" placeholder="自动生成的Dao.class，支持手动调整"></textarea>
            </div>
        </div>
        <div level="3" class="hide">
            <div class="form-group">
                <label for="serviceText">Service</label>
                <textarea id="serviceText" class="form-control" rows="3"
                          placeholder="自动生成的Service.class，支持手动调整"></textarea>
            </div>
            <div class="form-group">
                <label for="serviceImplText">ServiceImpl</label>
                <textarea id="serviceImplText" class="form-control" rows="3"
                          placeholder="自动生成的ServiceImpl.class，支持手动调整"></textarea>
            </div>
        </div>
        <div level="4" class="hide"></div>
    </div>
</div>
<script src="/js/jquery-3.4.1.min.js" type="text/javascript"></script>
<script src="/js/bootstrap.min.js" type="text/javascript"></script>
<script>
    /*工具方法*/
    function myAlert(msg, title) {
        $('#myAlert .modal-body p').html(msg);
        if (title) {
            $('#myAlert .modal-title').html(title);
        }
        $('#myAlert').modal({
            backdrop: 'static',
            keyboard: false,
            show: true
        });
    }

    //驼峰命名
    function camelCase(string) {
        return string.replace(/_([a-z])/g, function (all, letter) {
            return letter.toUpperCase();
        });
    }

    /*初始化入口*/
    $(() => {
        $.ajaxSetup({
            error(jqXHR, textStatus, errorThrown) {
                myAlert("请求失败，请稍后再试！")
            },
            dataFilter(data, type) {
                if (!data || data === "") {
                    myAlert("表数据加载失败！");
                    return false;
                }
                return data;
            }
        });
        initTables();
    });

    function initTables() {
        $('#tableList').html(`<option value="0">请选择...</option>`);
        $.get('/tables', result => {
            $(result).each((i, o) => {
                $('#tableList').append(`<option value="${o.name}" title="${o.comment}">${o.name}</option>`);
            });
        });
    }

    function initCode(tag) {
        let tableName = $('#tableList').val();

        //初始化类名
        let className = camelCase(tableName);
        className = className.substring(0, 1).toUpperCase() + className.substring(1, className.length);
        $('#className').val(className);

        //初始化类注释
        $('#tableComment').val($('#tableList option:checked').attr('title'));

        //初始化字段信息
        let $colTable = $('#colTable');
        $colTable.children('tbody').html('');
        $.get('/clos', {tableName: tableName}, result => {
            let $tbody = $colTable.children('tbody');
            $(result).each((i, o) => {
                $tbody.append(
                    `<tr>
                        <td>${i + 1}</td>
                        <td>${o.name}</td>
                        <td>${o.type}</td>
                        <td><input name="name" value="${camelCase(o.name)}" type="text" /></td>
                        <td><input name="type" value="${typeFormat(o.type)}" type="text" /></td>
                        <td><input name="isPrimary" value="${o.isPrimary}" type="text" /></td>
                        <td><input name="comment" value="${o.comment}" type="text" /></td>
                    </tr>`);
            });
        })
    }

    function createCode() {
        let conf = collectConf();
        if (!conf) {
            return;
        }
        myAlert(`<pre>${JSON.stringify(conf, null, 4)}</pre>`, "配置信息");
    }

    function collectConf() {
        let $tableList = $('#tableList');
        let tableName = $tableList.val();
        if (tableName === "0") {
            myAlert("请先选择表！");
            return;
        }
        let cols = [];
        $('#colTable tbody tr').each((i, e) => {
            $inputs = $(e).find('input');
            cols.push({
                name: $inputs[0].value,
                type: $inputs[1].value,
                comment: $inputs[2].value,
                isPrimary: $inputs[3].value === "1",
            })
        });

        return {
            tableName: tableName,
            tableComment: $('#tableComment').val(),
            className: $('#className').val(),
            level: $('#codeLevel').val(),
            author: $('#author').val(),
            useSwagger: $('#useSwagger:checked').length === 1,
            cols: cols
        };
    }

    function typeFormat(type) {
        if (typeof (type) != "string") {
            return "String";
        }
        type = type.trim();
        if (type.startsWith("int(")) {
            return "long";
        } else if (type.startsWith("datetime")) {
            return "Date";
        } else if (type.startsWith("char(")) {
            return "char";
        } else {
            return "String";
        }
    }
</script>
</body>
</html>
